<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thanh toán VietQR - Techcombank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 0 8px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 22px;
      margin-top: 0;
      text-align: center;
    }
    .note {
      font-size: 12px;
      color: #666;
    }
    .qr-section, .banks-section {
      margin-top: 16px;
    }
    .qr-img {
      display: block;
      margin: 12px auto;
      max-width: 260px;
    }

    /* Bank grid gọn + icon */
    .bank-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px;
      max-height: 420px;
      overflow-y: auto;
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    .bank-item {
      text-align: center;
      padding: 8px 4px;
      border-radius: 8px;
      background: #f9fafb;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }
    .bank-item:hover {
      background: #e3f2fd;
      box-shadow: 0 0 4px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    .bank-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
      border-radius: 6px;
      background: #fff;
      border: 1px solid #eee;
      margin-bottom: 4px;
    }
    .bank-name-short {
      font-size: 11px;
      font-weight: 600;
      color: #0d47a1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bank-name-full {
      font-size: 10px;
      color: #555;
      height: 24px;
      overflow: hidden;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Thanh toán qua VietQR</h1>

  <p class="note">
    Tài khoản nhận cố định: <br/>
    STK: <b>444555666001</b> – Ngân hàng Techcombank (BIN 970407)<br/>
    CTK: <b>NGÔ MAI NGUYÊN DƯƠNG</b> (CTK: NGO MAI NGUYEN DUONG)<br/>
    Vui lòng mở trang này bằng điện thoại để chọn logo ngân hàng và nhảy qua app.
  </p>

  <div class="qr-section">
    <h3>Mã VietQR</h3>
    <img id="qrImage" class="qr-img" alt="Đang tạo mã VietQR..." />
    <p class="note">
      QR được tạo tự động khi tải trang. Nếu không dùng API VietQR, có thể thay bằng ảnh QR tĩnh ngân hàng cấp sẵn.
    </p>
  </div>

  <div class="banks-section">
    <h3>Chọn ngân hàng để mở app</h3>
    <p class="note">
      Nhấn vào logo ngân hàng bạn dùng. Khi truy cập bằng điện thoại, hệ thống sẽ cố gắng mở app tương ứng (deeplink VietQR).
    </p>
    <div id="bankList" class="bank-list">
      Đang tải danh sách ngân hàng...
    </div>
  </div>
</div>

<script>
  // ===== 1. TÀI KHOẢN CỐ ĐỊNH CỦA BẠN =====
  const FIXED_ACCOUNT_NO   = "444555666001";           // STK
  const FIXED_ACCOUNT_NAME = "NGO MAI NGUYEN DUONG";   // không dấu, in hoa
  const FIXED_ACQ_ID       = "970407";                 // BIN Techcombank
  const FIXED_ADD_INFO     = "CHUYEN KHOAN CHO DUONG"; // nội dung
  const FIXED_AMOUNT       = "";                       // để "" cho khách tự nhập tiền trong app

  // ===== 2. CẤU HÌNH API VIETQR (CẦN THAY THẬT Ở ĐÂY) =====
  const VIETQR_CLIENT_ID = "d2ec01e1-3340-406e-8382-71b70f951b66";   // <--- NHÉT CLIENT_ID VÀO ĐÂY
  const VIETQR_API_KEY  = "2e454c88-2638-48e3-81b0-1a86842b71dd";    // <--- NHÉT API_KEY VÀO ĐÂY

  // Nếu không muốn dùng API (chỉ dùng ảnh QR tĩnh), bạn có thể gán trực tiếp:
  const STATIC_QR_IMAGE_URL = ""; // ví dụ: "https://your-domain.com/qr-techcom-444555666001.png"

  // ===== 3. URL API =====
  const GENERATE_QR_API = "https://api.vietqr.io/v2/generate";
  const BANK_LIST_API   = "https://api.vietqr.io/v2/banks";

  // ===== 4. TỰ TẠO MÃ VIETQR KHI LOAD TRANG =====
  async function autoGenerateQR() {
    const qrImage = document.getElementById("qrImage");

    // Trường hợp không dùng API VietQR, chỉ dùng ảnh QR tĩnh
    if ((!VIETQR_CLIENT_ID || !VIETQR_API_KEY) && STATIC_QR_IMAGE_URL) {
      qrImage.src = STATIC_QR_IMAGE_URL;
      qrImage.alt = "Mã VietQR (ảnh tĩnh)";
      return;
    }

    // Nếu chưa cấu hình API và cũng chưa có ảnh tĩnh thì báo
    if (!VIETQR_CLIENT_ID || !VIETQR_API_KEY) {
      qrImage.alt = "Chưa cấu hình API VietQR hoặc ảnh QR tĩnh.";
      return;
    }

    const payload = {
      accountNo:   FIXED_ACCOUNT_NO,
      accountName: FIXED_ACCOUNT_NAME,
      acqId:       FIXED_ACQ_ID,
      format:      "image",
      template:    "compact"
    };

    if (FIXED_AMOUNT)   payload.amount  = FIXED_AMOUNT;
    if (FIXED_ADD_INFO) payload.addInfo = FIXED_ADD_INFO;

    try {
      qrImage.src = "";
      qrImage.alt = "Đang tạo mã VietQR...";

      const res = await fetch(GENERATE_QR_API, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-client-id": VIETQR_CLIENT_ID,
          "x-api-key": VIETQR_API_KEY
        },
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (json.code !== "00") {
        console.error(json);
        qrImage.alt = "Tạo VietQR thất bại: " + (json.desc || "Lỗi không xác định");
        return;
      }

      qrImage.src = json.data.qrDataURL;
      qrImage.alt = "Mã VietQR";
    } catch (e) {
      console.error(e);
      qrImage.alt = "Lỗi gọi API VietQR, xem console để biết thêm chi tiết.";
    }
  }

  // ===== 5. LẤY DANH SÁCH NGÂN HÀNG + ICON, RENDER GRID =====
  function getAppCodeFromBank(bank) {
    // Ưu tiên code (VD: VCB, MBB, TCB...), fallback shortName
    if (bank.code) return bank.code.toLowerCase();
    if (bank.shortName) return bank.shortName.toLowerCase();
    return "";
  }

  async function loadBanks() {
    const bankListDiv = document.getElementById("bankList");
    bankListDiv.textContent = "Đang tải danh sách ngân hàng...";

    try {
      const res = await fetch(BANK_LIST_API);
      const json = await res.json();

      if (!json || !json.data) {
        bankListDiv.textContent = "Không lấy được dữ liệu ngân hàng.";
        return;
      }

      bankListDiv.innerHTML = "";

      json.data
        .filter(b => b.transferSupported === 1)
        .forEach(bank => {
          const appCode = getAppCodeFromBank(bank);
          if (!appCode) return;

          const item = document.createElement("div");
          item.className = "bank-item";

          const logo = document.createElement("img");
          logo.className = "bank-logo";
          logo.src = bank.logo;
          logo.alt = bank.shortName || bank.name || "Bank";

          const shortName = document.createElement("div");
          shortName.className = "bank-name-short";
          shortName.textContent = bank.shortName || bank.code;

          const fullName = document.createElement("div");
          fullName.className = "bank-name-full";
          fullName.textContent = bank.name;

          item.appendChild(logo);
          item.appendChild(shortName);
          item.appendChild(fullName);

          item.onclick = () => {
            const url = "https://dl.vietqr.io/pay?app=" + encodeURIComponent(appCode);
            window.open(url, "_blank");
          };

          bankListDiv.appendChild(item);
        });
    } catch (e) {
      console.error(e);
      bankListDiv.textContent = "Lỗi khi tải danh sách ngân hàng.";
    }
  }

  // ===== 6. TỰ CHẠY KHI MỞ TRANG =====
  autoGenerateQR();
  loadBanks();
</script>
</body>
</html>

          btn.href = "https://dl.vietqr.io/pay?app=" + encodeURIComponent(appCode);
          btn.target = "_blank";
          btn.rel = "noopener noreferrer";

          bankListDiv.appendChild(btn);
        });
    } catch (e) {
      console.error(e);
      bankListDiv.textContent = "Lỗi khi tải danh sách ngân hàng.";
    }
  }

  // Tự chạy khi mở trang
  autoGenerateQR();
  loadBanks();
</script>
</body>
</html>
